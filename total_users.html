<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo-taller-mecanico.png">
    <title>Taller Mecánico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!--<link rel="stylesheet" href="sweetalert2.min.css">-->
    <style>
    .btn-anim:hover {
      transform: scale(1.03);
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body class="bg-info">
    <div class="container py-5">
        <h2 class="text-dark fw-bold mb-4 text-center">Usuarios</h2>
        <div class="table table-responsive mb-4">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-primary text-center">
                    <tr>
                        <th scope="col">Usuario</th>
                        <th scope="col">Admin</th>
                        <th scope="col">Mecánico</th>
                        <th scope="col">Cliente</th>
                    </tr>
                </thead>
                <tbody>
                    <!--Los usuarios se agregan de manera dinámica-->
                </tbody>
            </table>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
            <a class="btn btn-dark btn-anim" href="menu.html">Regresar</a>
            <button class="btn btn-danger btn-anim" type="button" id="denyBtn">Eliminar</button>
            <button class="btn btn-success btn-anim" type="button" id="permitBtn">Asignar</button>
        </div>
    </div>
<!--Recursos de dependencias de Bootstrap, Sweetallezrt2 y anclaje de archivos de JavaScript-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!--Asignación de roles-->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, remove, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
  apiKey: "AIzaSyDOsQaU-vohMbkc7VujDgklWqz0Yebdjyo",
  authDomain: "appweb-mechanicworkshop.firebaseapp.com",
  databaseURL: "https://appweb-mechanicworkshop-default-rtdb.firebaseio.com",
  projectId: "appweb-mechanicworkshop",
  storageBucket: "appweb-mechanicworkshop.firebasestorage.app",
  messagingSenderId: "584226997397",
  appId: "1:584226997397:web:ec5661be0a15a7e686879c",
  measurementId: "G-9KGZGPBQSP"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  // Mostrar usuarios a la tabla dinámicamente
  const tbody = document.querySelector("tbody");
  let usuarios = [];
  
  onValue(ref(db, 'usuarios'), (snapshop) => {
    tbody.innerHTML = "";
    usuarios = [];

    if(snapshop.exists()) {
      snapshop.forEach(childSnapshot => {
        const uid = childSnapshot.key;
        const data = childSnapshot.val();
        usuarios.push({uid, email: data.email});

        const tr = document.createElement("tr");
        tr.className = "text-center align-middle";
        tr.innerHTML = `
          <td>${data.email}</td>
          <td><input type="checkbox" name="${uid}" value="admin" class="form-check-input" ${data.rol === "admin" ? "checked" : ""}></td>
          <td><input type="checkbox" name="${uid}" value="mecánico" class="form-check-input" ${data.rol === "mecánico" ? "checked" : ""}></td>
          <td><input type="checkbox" name="${uid}" value="cliente" class="form-check-input" ${data.rol === "cliente" ? "checked" : ""}></td>
        `;
        tbody.appendChild(tr);
      })
    }
  })

  // Botón para asignar roles
  document.getElementById("permitBtn").addEventListener("click", () => {
    usuarios.forEach(usuario => {
      const radios = document.getElementsByName(usuario.uid);
      let selectedRol = null;
      radios.forEach(radio => {
        if (radio.checked) selectedRol = radio.value;
      });

      if (selectedRol) {
        set(ref(db, 'usuarios/' + usuario.uid), {
          email: usuario.email,
          rol: selectedRol
        }).then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Rol asignado',
                text: `Se asignó el rol como ${selectedRol} al usuario: ${usuario.email}`,
                timer: 2500,
                showConfirmButton: false,
                background: '#000000',
                color: '#ffffff'
            });
        }).catch(err => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `Error al asignar el rol de este usuario: ${usuario.email}`,
                timer: 2500,
                showConfirmButton: false,
                background: '#000000',
                color: '#ffffff'
            });
        });
      }
    });
  });

// Botón para borrar roles
document.getElementById("denyBtn").addEventListener("click", () => {
  usuarios.forEach(usuario => {
    const radios = document.getElementsByName(usuario.uid);
    let checked = false;
    radios.forEach(radio => {
      if (radio.checked) checked = true;
    });

    if (checked) {
      remove(ref(db, 'usuarios/' + usuario.uid + '/rol'), "")
        .then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Rol eliminado',
                text: `Se eliminó el rol de este usuario: ${usuario.email}`,
                timer: 2500,
                showConfirmButton: false,
                background: '#000000',
                color: '#ffffff'
            });
        })
        .catch(err => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `No se pudo eliminar el rol de este usuario: ${usuario.email}`,
                timer: 2500,
                showConfirmButton: false,
                background: '#000000',
                color: '#ffffff'
            });
        });
    }
  });
});
</script>
</body>
</html>