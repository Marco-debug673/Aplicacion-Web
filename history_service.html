<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo-taller-mecanico.png">
    <title>Taller Mecánico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!--<link rel="stylesheet" href="sweetalert2.min.css">-->
    <style>
    .btn-anim:hover {
      transform: scale(1.03);
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body class="bg-info">
    <div class="container py-5">
        <h2 class="text-dark fw-bold mb-4 text-center">Solicitud de Servicios</h2>
        <div class="table table-responsive mb-4">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-primary text-center">
                    <tr>
                        <th scope="col">Nombre</th>
                        <th scope="col">Apellidos</th>
                        <th scope="col">Número de Teléfono</th>
                        <th scope="col">Vehículo</th>
                        <th scope="col">Falla Detectada</th>
                        <th scope="col">Estado de Reparación</th>
                    </tr>
                </thead>
                <tbody id="table-services">
                    <!-- Aquí se insertarán las filas dinámicamente -->
                </tbody>
            </table>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
            <a class="btn btn-dark btn-anim" href="menu.html">Regresar</a>
            <button class="btn btn-warning btn-anim" type="submit" id="saveBtn">Guardar</button>
        </div>
    </div>
    <!--En esta tabla se pueden ver los datos del vehículo-->
    <div class="container py-5">
        <h2 class="text-dark fw-bold mb-4 text-center">Datos del Vehículo</h2>
        <div class="table table-responsive mb-4">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-primary text-center">
                    <tr>
                        <th scope="col">Marca</th>
                        <th scope="col">Modelo</th>
                        <th scope="col">Año</th>
                        <th scope="col">Tipo de Camioneta</th>
                        <th scope="col">Capacidad de Carga</th>
                        <th scope="col">Cilindraje</th>
                        <th scope="col">Tipo de Moto</th>
                        <th scope="col">Tipo de Combustible</th>
                        <th scope="col">Color</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se insertarán las filas dinámicamente -->
                </tbody>
            </table>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
            <a class="btn btn-dark btn-anim" href="menu.html">Regresar</a>
        </div>
    </div>
<!--Recursos de dependencias de Bootstrap, Sweetallezrt2 y anclaje de archivos de JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Firebase SDK como módulo en línea -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, get, onValue, set, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDOsQaU-vohMbkc7VujDgklWqz0Yebdjyo",
            authDomain: "appweb-mechanicworkshop.firebaseapp.com",
            databaseURL: "https://appweb-mechanicworkshop-default-rtdb.firebaseio.com",
            projectId: "appweb-mechanicworkshop",
            storageBucket: "appweb-mechanicworkshop.appspot.com",
            messagingSenderId: "584226997397",
            appId: "1:584226997397:web:ec5661be0a15a7e686879c",
            measurementId: "G-9KGZGPBQSP"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth();

        window.addEventListener("DOMContentLoaded", () => {
            const rol = localStorage.getItem("rol");
            const tableBody = document.getElementById("table-services");
            const saveBtn = document.getElementById("saveBtn");
            const solicitudesKeys = [];
            const vehiculosTbody = document.querySelectorAll("table")[1].querySelector("tbody");
            const vehiculosTable = document.querySelectorAll("table")[1];

            // Solo mostrar botón si es mecánico
            saveBtn.style.display = rol === "mecánico" ? "block" : "none";

            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    console.error("Usuario no autenticado");
                    return;
                }

                let solicitudesRef;
                if (rol === "mecánico" || rol === "admin") {
                    // Mecánicos y admins ven todo
                    solicitudesRef = ref(database, "solicitudes");
                } else {
                    // Clientes solo ven sus datos
                    solicitudesRef = query(
                    ref(database, "solicitudes"),
                    orderByChild("uid"),
                    equalTo(user.uid)
                    );
                }

                onValue(solicitudesRef, (snapshot) => {
                    tableBody.innerHTML = "";
                    solicitudesKeys.length = 0;
                    let index = 0;

                    snapshot.forEach((childSnapshot) => {
                        const key = childSnapshot.key;
                        const solicitud = childSnapshot.val();
                        solicitudesKeys.push(key);

                        const estadoActual = solicitud.estado || "Seleccione una opción";
                        let celdaEstado = "";

                        if (rol === "mecánico") {
                            celdaEstado = `
                            <select class="form-select" id="estadoSelect${index}">
                                <option value="Seleccione una opción" ${estadoActual === "Seleccione una opción" ? "selected" : ""}>Seleccione una opción</option>
                                <option value="Recibido" ${estadoActual === "Recibido" ? "selected" : ""}>Recibido</option>
                                <option value="En revisión" ${estadoActual === "En revisión" ? "selected" : ""}>En revisión</option>
                                <option value="En reparación" ${estadoActual === "En reparación" ? "selected" : ""}>En reparación</option>
                                <option value="Listo para entregar" ${estadoActual === "Listo para entregar" ? "selected" : ""}>Listo para entregar</option>
                            </select>`;
                        } else {
                            celdaEstado = `<span>${estadoActual}</span>`;
                        }

                        const fila = document.createElement("tr");
                        fila.classList.add("text-center");
                        fila.innerHTML = `
                        <td>${solicitud.nombre || ""}</td>
                        <td>${solicitud.apellidos || ""}</td>
                        <td>${solicitud.numerotelefono || ""}</td>
                        <td>${solicitud.tipovehiculo?.tipo || ""}</td>
                        <td>${solicitud.falladetectada || ""}</td>
                        <td>${celdaEstado}</td>
                        `;
                        tableBody.appendChild(fila);
                        index++;
                    });

                    vehiculosTbody.innerHTML = "";
                    const columnasVisibles = {
                        tipoCamioneta: false,
                        capacidadCarga: false,
                        cilindraje: false,
                        tipoMoto: false
                    };

                    snapshot.forEach((childSnapshot) => {
                        const data = childSnapshot.val();
                        const datos = data.tipovehiculo?.datos || {};

                        if (datos.tipoCamioneta) columnasVisibles.tipoCamioneta = true;
                        if (datos.capacidadCarga) columnasVisibles.capacidadCarga = true;
                        if (datos.cilindraje) columnasVisibles.cilindraje = true;
                        if (datos.tipoMoto) columnasVisibles.tipoMoto = true;
                        
                        const fila = document.createElement("tr");
                        fila.classList.add("text-center");
                        fila.innerHTML = `
                        <td>${datos.marca || ""}</td>
                        <td>${datos.modelo || ""}</td>
                        <td>${datos.anio || ""}</td>
                        <td class="col-tipoCamioneta">${datos.tipoCamioneta || ""}</td>
                        <td class="col-capacidadCarga">${datos.capacidadCarga || ""}</td>
                        <td class="col-cilindraje">${datos.cilindraje || ""}</td>
                        <td class="col-tipoMoto">${datos.tipoMoto || ""}</td>
                        <td>${datos.combustible || ""}</td>
                        <td>${datos.color || ""}</td>
                        `;
                        vehiculosTbody.appendChild(fila);
                    });

                    if (!columnasVisibles.tipoCamioneta) ocultarColumna(vehiculosTable, 3);
                    if (!columnasVisibles.capacidadCarga) ocultarColumna(vehiculosTable, 4);
                    if (!columnasVisibles.cilindraje) ocultarColumna(vehiculosTable, 5);
                    if (!columnasVisibles.tipoMoto) ocultarColumna(vehiculosTable, 6);
                });
            });
            // Guardar los cambios solo si es mecánico
            saveBtn.addEventListener("click", () => {
                if (rol !== "mecánico") return;

                const selects = document.querySelectorAll("select[id^='estadoSelect']");
                const updates = [];

                selects.forEach((select, i) => {
                    const estado = select.value;
                    const solicitudKey = solicitudesKeys[i];

                    const estadoRef = ref(database, `solicitudes/${solicitudKey}/estado`);
                    updates.push(set(estadoRef, estado));
                });

                Promise.all(updates)
                .then(() => {
                    Swal.fire({
                        icon: "success",
                        text: "El estado de reparación fue guardado correctamente.",
                        timer: 3000,
                        showConfirmButton: false,
                        background: "#000000",
                        color: "#ffffff"
                    });
                })
                .catch((error) => {
                    console.error("Error al guardar estados:", error);
                });
            });
            
            function ocultarColumna(tabla, index) {
                for (const fila of tabla.rows) {
                    if (fila.cells[index]) {
                        fila.cells[index].style.display = "none";
                    }
                }
            }
        }, (error) => {
            console.error("Error al escuchar los datos de servicios:", error);
        });
    </script>
</body>
</html>