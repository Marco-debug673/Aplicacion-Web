<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo-taller-mecanico.png">
    <title>Taller Mecánico</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!--<link rel="stylesheet" href="sweetalert2.min.css">-->
    <style>
    .btn-anim:hover {
        transition: all 0.3s ease;
        border-radius: 6px;
    }
    .bi {
        background: transparent !important;
        color: inherit;
    }
    .btn-anim:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body class="bg-info">
    <div class="container py-5">
        <h2 class="text-dark fw-bold mb-4 text-center">Historial de Citas</h2>
        <div class="table table-responsive mb-4">
            <form id="formBuscador" style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem;">
                <input type="date" class="form-control" id="busquedaInput" placeholder="Seleccione una fecha" style="max-width: 200px;">
                <button type="submit" class="btn btn-anim d-flex justify-content-center align-items-center" id="searchBtn" style="width: 45px; height: 30px;">
                <i class="bi bi-search fs-4 text-dark"></i></button>
            </form>
            <table class="table table-bordered table-hover bg-white mt-3">
                <thead class="table-primary text-center">
                    <tr>
                        <th scope="col">Seleccionar</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Apellidos</th>
                        <th scope="col">Fecha</th>
                        <th scope="col">Hora</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Aquí se insertarán las filas dinámicamente -->
                </tbody>
            </table>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3">
            <a class="btn btn-dark btn-anim" href="menu.html">Regresar</a>
            <button class="btn btn-danger btn-anim" type="button" id="deleteBtn">Eliminar</button>
            <!--<button class="btn btn-warning btn-anim" type="submit" id="updateBtn">Actualizar</button>-->
        </div>
    </div>
<!--Recursos de dependencias de Bootstrap, Sweetallezrt2 y anclaje de archivos de JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--<script type="module" src="history_appointment.js"></script>-->
<!-- Firebase SDK como módulo en línea -->
 <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
import { getDatabase, ref, get, remove, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

// Configuración de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDOsQaU-vohMbkc7VujDgklWqz0Yebdjyo",
    authDomain: "appweb-mechanicworkshop.firebaseapp.com",
    databaseURL: "https://appweb-mechanicworkshop-default-rtdb.firebaseio.com",
    projectId: "appweb-mechanicworkshop",
    storageBucket: "appweb-mechanicworkshop.appspot.com",
    messagingSenderId: "584226997397",
    appId: "1:584226997397:web:ec5661be0a15a7e686879c",
    measurementId: "G-9KGZGPBQSP"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth();

window.addEventListener("DOMContentLoaded", () => {
    const tbody = document.querySelector("tbody");
    const searchInput = document.getElementById("busquedaInput");
    const searchBtn = document.getElementById("searchBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const formBuscador = document.getElementById("formBuscador");
    const rol = localStorage.getItem("rol");

    if (!rol || rol.toLowerCase() !== "mecánico") {
        if (formBuscador) formBuscador.style.display = "none";
    }

    if (!rol || rol.toLowerCase() !== "cliente") {
        if (deleteBtn) deleteBtn.style.display = "none";
    }

    let citas = [];

    function mostrarCitas(lista) {
        tbody.innerHTML = "";
        let index = 1;

        lista.forEach((data) => {
            const fila = document.createElement("tr");
            fila.classList.add("text-center", "align-middle");
            fila.setAttribute("data-id", data.id);

            fila.innerHTML = `
                <td>
                    <div class="form-check d-flex justify-content-center">
                        <input class="form-check-input" type="checkbox" id="check${index}">
                    </div>
                </td>
                <td>${data.nombre || ""}</td>
                <td>${data.apellidos || ""}</td>
                <td>${data.fecha || ""}</td>
                <td>${data.hora || ""}</td>
            `;
            tbody.appendChild(fila);
            index++;
        });
    }

    onAuthStateChanged(auth, (user) => {
        if (!user) {
            console.error("Usuario no autenticado");
            return;
        }
    
        let citasRef;

        if (rol === "mecánico" || rol === "admin") {
            // Mecánico/Admin → ven todo
            citasRef = ref(database, "Citas");
        } else {
            // Cliente → solo sus citas
            citasRef = query(
                ref(database, "Citas"),
                orderByChild("uid"),
                equalTo(user.uid)
            );
        }

        onValue(citasRef, (snapshot) => {
            let hayDatos = false;
            const citasTemp = [];

            snapshot.forEach((childSnapshot) => {
                hayDatos = true;
                const data = childSnapshot.val();
                const id = childSnapshot.key;
                citasTemp.push({ id, ...data });
            });

            if (hayDatos) {
                citas = citasTemp;
                mostrarCitas(citas);
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center">No hay citas agendadas.</td></tr>`;
            }
        }, (error) => {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: "Error al obtener datos",
                background: '#000000',
                color: '#ffffff',
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#0d6efd"
            });
        });
    });

    function convertFormatDDMMYYYY(fechaISO) {
        const [anio, mes, dia] = fechaISO.split("-");
        return `${dia}/${mes}/${anio}`;
    }
    searchBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const valorInput = searchInput.value.trim();
        if (!valorInput) {
            mostrarCitas(citas);
            return;
        }
        const filtro = convertFormatDDMMYYYY(valorInput);

        const resultados = citas.filter((cita) => cita.fecha === filtro);

        if (resultados.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center">No hay ninguna cita agendada para esta fecha.</td></tr>`;
        } else {
            mostrarCitas(resultados);
        }
    });
    deleteBtn.addEventListener("click", () => {
        const filas = document.querySelectorAll("tbody tr");
        let seleccionadas = [];

        filas.forEach((fila) => {
            const checkbox = fila.querySelector("input[type='checkbox']");
            if (checkbox && checkbox.checked) {
                const id = fila.getAttribute("data-id");
                if (id) {
                    seleccionadas.push({ id, fila });
                }
            }
        });

        if (seleccionadas.length === 0) {
            Swal.fire({
                icon: "info",
                text: "Seleccione al menos una cita para eliminar.",
                background: '#000000',
                color: '#ffffff',
                confirmButtonText: "Aceptar",
                confirmButtonColor: "#0d6efd"
            });
            return;
        }
        Swal.fire({
            title: "¿Está seguro de que desea eliminar la cita?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#6c757d",
            confirmButtonText: "Sí, eliminar",
            cancelButtonText: "Cancelar",
            background: '#000000',
            color: '#ffffff'
        }).then((result) => {
            if (result.isConfirmed) {
                let eliminadas = 0;

                seleccionadas.forEach(({ id, fila }) => {
                    const citaRef = ref(database, `Citas/${id}`);

                    remove(citaRef)
                        .then(() => {
                            fila.remove();
                            citas = citas.filter(c => c.id !== id);
                        })
                        .catch((error) => {
                            console.error("Error al eliminar la cita:", error);
                        });
                });

                Swal.fire({
                    icon: "success",
                    title: "Cita Eliminada",
                    text: "La cita seleccionada ha sido eliminada.",
                    background: '#000000',
                    color: '#ffffff',
                    confirmButtonText: "Aceptar",
                    confirmButtonColor: "#0d6efd"
                });
            }
        });
    });
});
</script>
</body>
</html>